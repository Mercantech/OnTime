<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OnTime</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .secret-page { padding: 1.5rem 2rem; max-width: 1200px; margin: 0 auto; }
    .secret-page h1 { font-size: 1.5rem; margin: 0 0 1rem; }
    .secret-page .back { color: var(--text-muted); margin-bottom: 1rem; }
    .secret-page .back a { color: var(--accent); }
    .secret-user-select { margin-bottom: 1.5rem; }
    .secret-user-select label { display: block; margin-bottom: 0.35rem; color: var(--text-muted); font-size: 0.9rem; }
    .secret-user-select select { min-width: 280px; padding: 0.5rem 0.75rem; background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-size: 1rem; }
    .sessions-table-wrap { overflow-x: auto; }
    .sessions-table { width: 100%; border-collapse: collapse; background: var(--surface); border-radius: var(--radius); overflow: hidden; }
    .sessions-table th, .sessions-table td { padding: 0.65rem 0.9rem; text-align: left; border-bottom: 1px solid var(--border); }
    .sessions-table th { background: var(--surface-2); color: var(--text-muted); font-size: 0.85rem; font-weight: 600; }
    .sessions-table tr:last-child td { border-bottom: none; }
    .sessions-table .jti-cell { font-family: ui-monospace, monospace; font-size: 0.9rem; }
    .sessions-table .user-agent-cell { max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .sessions-table .revoked { color: var(--text-muted); font-style: italic; }
    .btn-disable { padding: 0.35rem 0.65rem; font-size: 0.85rem; background: var(--danger); color: #fff; border: none; border-radius: var(--radius-sm); cursor: pointer; }
    .btn-disable:hover:not(:disabled) { background: var(--danger-dim); }
    .btn-disable:disabled { opacity: 0.5; cursor: not-allowed; }
    .secret-msg { margin-top: 0.75rem; color: var(--text-muted); font-size: 0.9rem; }
    .secret-error { color: var(--danger); }
  </style>
</head>
<body>
  <div class="secret-page">
    <p class="back"><a href="/admin">← Admin</a></p>
    <h1>Sessioner (logins)</h1>
    <p class="secret-msg">Vælg bruger for at se aktive logins. Du kan deaktivere en enkelt session (JWT), så den token ikke længere gælder.</p>
    <div class="secret-user-select">
      <label for="user-select">Bruger</label>
      <select id="user-select">
        <option value="">Vælg bruger…</option>
      </select>
    </div>
    <div id="sessions-wrap" class="sessions-table-wrap" hidden>
      <table class="sessions-table" id="sessions-table">
        <thead>
          <tr>
            <th>JWT (id)</th>
            <th>IP</th>
            <th>Enhed</th>
            <th>Oprettet</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="sessions-body"></tbody>
      </table>
    </div>
    <p id="sessions-empty" class="secret-msg" hidden>Ingen sessioner for denne bruger.</p>
    <p id="sessions-error" class="secret-msg secret-error" hidden></p>
  </div>
  <script>
(function () {
  const token = localStorage.getItem('ontime_token');
  if (!token) {
    window.location.href = '/login';
    return;
  }

  const api = async (url, opts = {}) => {
    const res = await fetch(url, {
      ...opts,
      headers: { ...opts.headers, Authorization: 'Bearer ' + token },
    });
    if (res.status === 401) {
      localStorage.removeItem('ontime_token');
      window.location.href = '/login';
      throw new Error('Log ind igen');
    }
    if (res.status === 403) {
      window.location.href = '/admin';
      throw new Error('Kun for administratorer');
    }
    return res;
  };

  const userSelect = document.getElementById('user-select');
  const sessionsWrap = document.getElementById('sessions-wrap');
  const sessionsBody = document.getElementById('sessions-body');
  const sessionsEmpty = document.getElementById('sessions-empty');
  const sessionsError = document.getElementById('sessions-error');

  function showError(msg) {
    sessionsError.textContent = msg || '';
    sessionsError.hidden = !msg;
  }

  // Indlæs brugere
  api('/api/admin/users')
    .then((r) => r.json())
    .then((users) => {
      userSelect.innerHTML = '<option value="">Vælg bruger…</option>' +
        users.map((u) => `<option value="${u.id}">${escapeHtml(u.name)} (${escapeHtml(u.email)})</option>`).join('');
    })
    .catch((e) => {
      showError(e.message || 'Kunne ikke hente brugere');
    });

  function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  function formatDate(d) {
    if (!d) return '–';
    const dt = new Date(d);
    return dt.toLocaleString('da-DK', { dateStyle: 'short', timeStyle: 'short' });
  }

  userSelect.addEventListener('change', () => {
    const userId = userSelect.value;
    sessionsWrap.hidden = true;
    sessionsEmpty.hidden = true;
    showError('');
    if (!userId) return;

    api('/api/admin/secret/sessions?userId=' + encodeURIComponent(userId))
      .then((r) => r.json())
      .then((data) => {
        const sessions = data.sessions || [];
        if (sessions.length === 0) {
          sessionsEmpty.hidden = false;
          return;
        }
        sessionsBody.innerHTML = sessions.map((s) => {
          const revoked = !!s.revokedAt;
          const status = revoked ? 'Deaktiveret ' + formatDate(s.revokedAt) : 'Aktiv';
          const btn = revoked
            ? '<span class="revoked">Deaktiveret</span>'
            : '<button type="button" class="btn-disable" data-jti="' + escapeHtml(s.jti) + '">Deaktivér</button>';
          return '<tr>' +
            '<td class="jti-cell" title="' + escapeHtml(s.jti) + '">…' + escapeHtml(s.jtiShort || s.jti?.slice(-8) || '') + '</td>' +
            '<td>' + escapeHtml(s.ip || '–') + '</td>' +
            '<td class="user-agent-cell" title="' + escapeHtml(s.userAgent || '') + '">' + escapeHtml((s.userAgent || '–').slice(0, 60)) + (s.userAgent && s.userAgent.length > 60 ? '…' : '') + '</td>' +
            '<td>' + formatDate(s.createdAt) + '</td>' +
            '<td class="' + (revoked ? 'revoked' : '') + '">' + status + '</td>' +
            '<td>' + btn + '</td></tr>';
        }).join('');
        sessionsWrap.hidden = false;
        sessionsBody.querySelectorAll('.btn-disable').forEach((btn) => {
          btn.addEventListener('click', () => revoke(btn.dataset.jti));
        });
      })
      .catch((e) => {
        showError(e.message || 'Kunne ikke hente sessioner');
      });
  });

  function revoke(jti) {
    if (!jti) return;
    api('/api/admin/secret/sessions/' + encodeURIComponent(jti) + '/revoke', { method: 'POST' })
      .then((r) => r.json())
      .then(() => {
        userSelect.dispatchEvent(new Event('change'));
      })
      .catch((e) => {
        showError(e.message || 'Kunne ikke deaktivere session');
      });
  }
})();
  </script>
</body>
</html>
